### **网络层（数据平面）-2**  
---

#### **1. IP地址与子网划分**  
**IPv4地址分类**  
| **类别** | **前缀** | **网络范围**         | **主机数/网络** | **用途**               |  
|----------|----------|----------------------|-----------------|------------------------|  
| A类      | 0        | 1.0.0.0 - 126.0.0.0  | 16,777,214      | 早期大型机构           |  
| B类      | 10       | 128.0.0.0 - 191.255.0.0 | 65,534         | 中型企业               |  
| C类      | 110      | 192.0.0.0 - 223.255.255.0 | 254            | 小型网络               |  
| D类      | 1110     | 224.0.0.0 - 239.255.255.255 | N/A           | 组播地址               |  

**子网划分（Subnetting）**  
- **目的**：提高地址利用率，减少广播域。  
- **子网掩码**：标识网络部分（如`255.255.255.0`表示前24位为网络号）。  
- **CIDR表示法**：`IP地址/前缀长度`（如`192.168.1.0/24`）。  

**示例**：  
- 原始网络：`192.168.1.0/24` → 划分为4个子网：  
  - `192.168.1.0/26`（主机范围：1-62）  
  - `192.168.1.64/26`（63-126）  
  - `192.168.1.128/26`（127-190）  
  - `192.168.1.192/26`（191-254）  

---

#### **2. DHCP与动态地址分配**  
**DHCP工作流程**（四步握手）：  
1. **Discover**：客户端广播发现DHCP服务器。  
2. **Offer**：服务器回复可用IP地址（单播/广播）。  
3. **Request**：客户端确认请求分配的IP。  
4. **Ack**：服务器最终确认，分配租期。  

**关键字段**：  
- **子网掩码**、**默认网关**、**DNS服务器**可一并分配。  
- **租期管理**：客户端需定期续租（T1=50%租期，T2=87.5%租期）。  

---

#### **3. 网络地址转换（NAT）**  
**原理**：  
- **私有IP ↔ 公有IP映射**（如`10.0.0.1` → `138.76.29.7`）。  
- **NAT表项**：记录内部地址与端口号（如`10.0.0.1:3345` ↔ `138.76.29.7:5001`）。  

**类型**：  
| **类型**       | **特点**                              | **应用场景**       |  
|----------------|---------------------------------------|--------------------|  
| **静态NAT**    | 一对一固定映射                        | 服务器对外发布     |  
| **动态NAT**    | 公有IP池动态分配                      | 企业内网           |  
| **PAT（NAPT）**| 多私有IP共享单一公有IP（通过端口区分）| 家庭路由器         |  

**局限性**：  
- 破坏端到端透明性，需ALG支持FTP/SIP等协议。  

---

#### **4. IPv6核心改进**  
**与IPv4对比**：  
| **特性**         | **IPv4**                  | **IPv6**                          |  
|------------------|---------------------------|-----------------------------------|  
| **地址长度**     | 32位（约42亿）            | 128位（3.4×10³⁸）                |  
| **头部格式**     | 复杂（含校验和、分片）    | 简化（固定40字节，无校验和）      |  
| **分片处理**     | 路由器可分片              | 仅源端分片                       |  
| **QoS支持**      | 依赖TOS字段               | 流标签（Flow Label）              |  

**关键字段**：  
- **Flow Label**：标识同一流的分组（支持优先级路由）。  
- **Next Header**：替代IPv4的Protocol字段，支持扩展头部链（如路由头、分片头）。  

**过渡技术**：  
- **双栈（Dual Stack）**：设备同时运行IPv4/IPv6。  
- **隧道（Tunneling）**：IPv6分组封装在IPv4中传输（如6to4）。  

---

#### **5. 通用转发与SDN**  
**OpenFlow流表**：  
| **匹配字段**       | **动作**                     | **示例**                          |  
|--------------------|------------------------------|-----------------------------------|  
| 源IP、目的IP       | 转发到指定端口               | `src=10.1.*.*, dst=192.168.*.* → forward(2)` |  
| TCP端口号          | 丢弃或标记                   | `dst_port=80 → drop`              |  
| VLAN优先级         | 修改ToS字段                  | `vlan_pri=5 → set_tos(0x28)`     |  

**SDN架构**：  
1. **数据平面**：交换机按流表执行匹配+动作。  
2. **控制平面**：控制器（如OpenDaylight）集中计算流表并下发。  
3. **北向API**：应用通过RESTful API定义网络策略（如负载均衡）。  

---

#### **6. 中间盒（Middlebox）**  
**常见类型**：  
| **设备**       | **功能**                      | **部署位置**           |  
|----------------|-------------------------------|------------------------|  
| **防火墙**     | 流量过滤（ACL规则）           | 企业网关               |  
| **负载均衡器** | 分发请求到多台服务器          | 数据中心入口           |  
| **NAT**        | 地址转换                      | 家庭路由器             |  
| **缓存服务器** | 存储热门内容（如CDN节点）     | ISP网络边缘           |  

**SDN与NFV**：  
- **SDN**：控制与转发分离，集中化管理。  
- **NFV**：将中间盒功能虚拟化（如vFirewall运行在通用服务器）。  