### **网络层（数据平面）-1**  
---

#### **1. 网络层核心功能**  
**数据平面 vs 控制平面**  
| **特性**       | **数据平面（Data Plane）**          | **控制平面（Control Plane）**          |  
|----------------|------------------------------------|---------------------------------------|  
| **功能**       | 本地路由决策（查表转发）           | 全局路由计算（生成转发表）             |  
| **实现位置**   | 路由器硬件（ASIC/NPU）             | 路由协议（OSPF/BGP）或SDN控制器       |  
| **关键操作**   | 分组头解析、最长前缀匹配（LPM）    | 路径选择、拓扑发现                    |  

**服务模型**：  
- **尽力而为（Best Effort）**：IP基础服务，无带宽/延迟保证。  
- **QoS扩展**：通过TOS字段（如DiffServ）提供优先级标记。  

---

#### **2. 路由器架构与关键组件**  
**核心组件**：  
1. **输入端口**：  
   - **功能**：物理层接收 → 链路层解帧 → IP头更新（TTL减1、校验和重算） → **LPM查表**。  
   - **挑战**：高速处理（40Gbps需20ns/分组）。  
   - **实现**：专用硬件（TCAM实现LPM）。  

2. **交换结构（Switching Fabric）**：  
   | **类型**       | **原理**                          | **性能**          | **应用场景**       |  
   |----------------|-----------------------------------|-------------------|--------------------|  
   | **内存交换**   | CPU拷贝分组到内存                 | 低（受内存带宽限制） | 早期路由器         |  
   | **总线交换**   | 共享总线传输分组                  | 中（总线竞争）     | 企业级路由器       |  
   | **交叉开关**   | 并行多路径交换（Crossbar）        | 高（无阻塞）       | 核心路由器         |  

3. **输出端口**：  
   - **队列管理**：缓冲溢出时丢弃策略（如尾丢弃、RED）。  
   - **调度算法**：  
     - **FIFO**：简单但无法区分流量优先级。  
     - **优先级调度**：高优先级队列优先发送。  
     - **WFQ**：按权重分配带宽，保障最小速率。

4. **路由选择处理器**
  - 运行路由协议（控制平面），维护路由表。 

---

#### **3. IP分组结构（IPv4头部）**  
**关键字段解析**：  
| **字段名**         | **长度（比特）** | **作用**                                                                 |  
|--------------------|------------------|--------------------------------------------------------------------------|  
| **版本（Version）**| 4                | IPv4（值为4）或IPv6（值为6）                                             |  
| **IHL**           | 4                | 头部长度（以4字节为单位，最小值为5，即20字节）                           |  
| **TOS**           | 8                | 服务类型（现用于DiffServ/ECN）                                           |  
| **总长度**        | 16               | 分组总长（最大65535字节，受MTU限制）                                     |  
| **标识/标志/片偏移** | 16/3/13        | 分片重组（DF=1禁止分片，MF=1表示后续还有分片）                           |  
| **TTL**           | 8                | 跳数限制（防环路，每经过路由器减1）                                      |  
| **协议**          | 8                | 上层协议（如TCP=6，UDP=17）                                              |  
| **头部校验和**    | 16               | 仅校验头部（每跳重新计算）                                               |  
| **源/目的IP**     | 32/32            | 32位IPv4地址                                                             |  

**分片示例**：  
- 原始分组4000字节，MTU=1500 → 分3片（1480+1480+1040字节）。  
- 片偏移量 = 原始数据偏移 / 8（如第二片偏移量为185）。  

---

#### **4. 关键算法与协议**  
**最长前缀匹配（LPM）**：  
- **问题**：根据目标IP查找转发表中最具体的路由条目（如`192.168.1.0/24`比`192.168.0.0/16`更匹配`192.168.1.5`）。  
- **实现**：  
  - **Trie树**：二进制前缀树，时间复杂度O(前缀长度)。  
  - **硬件加速**：TCAM（三态内容寻址存储器）实现并行匹配。  

**分组调度算法**
| **算法**         | **原理**                                  | **特点**                          |
|------------------|-------------------------------------------|-----------------------------------|
| **FIFO**         | 先进先出，无优先级区分                    | 简单，但无法保障QoS               |
| **优先权排队**   | 高优先级队列优先发送                      | 可能饿死低优先级流量              |
| **循环（RR）**   | 轮流从各队列发送一个分组                  | 基本公平，但未考虑分组大小        |
| **WFQ**          | 按权重分配带宽（如权重3:1 → 75% vs 25%）  | 保障最小带宽，支持QoS             |


