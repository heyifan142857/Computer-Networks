### **运输层-1**  
---

#### **1. 运输层基础**  
**功能与角色**  
- **核心作用**：  
  - **进程间通信**：通过端口（Port）实现多路复用/分解（Multiplexing/Demultiplexing）。  
  - **增强IP服务**：提供可靠性（如TCP）或轻量传输（如UDP）。  
- **关键协议**：  
  - **TCP**：可靠、面向连接、流量控制、拥塞控制。  
  - **UDP**：无连接、不可靠、低延迟。  

**多路复用与分解**  
- **复用（Mux）**：多个应用进程数据合并为单一传输层报文段。  
- **分解（Demux）**：根据报文段头部信息（端口号、IP地址）分发到正确套接字。  
  - **UDP**：仅依赖目标端口号。  
  - **TCP**：需四元组（源IP、源端口、目标IP、目标端口）。  

---

#### **2. 可靠传输设计**  
**挑战与机制**  
| **问题**          | **解决方案**                          | **实现方式**                              |
|-------------------|--------------------------------------|------------------------------------------|
| **数据损坏**       | 校验和（Checksum）                   | 接收方检测错误，发送NAK请求重传。         |
| **丢包**           | 超时重传（Timeout + Retransmission） | 发送方设置计时器，超时未收到ACK则重传。   |
| **乱序/重复**      | 序列号（Sequence Numbers）           | 标识数据包顺序，接收方丢弃重复或乱序包。  |

**停等协议（Stop-and-Wait）**  
- **流程**：  
  1. 发送方发送包，启动计时器。  
  2. 接收方校验后回复ACK/NAK。  
  3. 发送方收到ACK则发送下一包；超时或NAK则重传。  
- **缺点**：效率低（吞吐量 ≈ 数据大小/RTT）。  

---

#### **3. 滑动窗口协议**  
**核心思想**  
- **窗口（Window）**：允许发送方连续发送多个未确认的包（窗口大小 = n）。  
- **吞吐量提升**：`MIN(n * 数据大小/RTT, 链路带宽)`。  

**两种确认方式**  
| **类型**         | **特点**                                  | **示例**                              |
|------------------|------------------------------------------|---------------------------------------|
| **累计确认（GBN）** | ACK表示“期望下一个包序号”，丢弃乱序包。   | 发送包1-3，收到ACK(4)表示1-3均成功。  |
| **选择确认（SR）**  | 单独确认每个正确接收的包，缓存乱序包。    | 发送包1-3，收到ACK(1)、ACK(3)则重传2。|

**协议对比**  
| **特性**       | **Go-Back-N (GBN)**               | **Selective Repeat (SR)**          |
|----------------|-----------------------------------|------------------------------------|
| **重传效率**   | 低（重传整个窗口）                | 高（仅重传丢失包）                 |
| **复杂度**     | 简单（单一计时器）                | 复杂（每个包需独立计时器）         |
| **适用场景**   | 低错误率环境                      | 高错误率环境                       |

---

#### **4. 关键图表与示例**  
**滑动窗口示意图**  
```
发送方窗口：[A+1, A+2, ..., A+n]  
接收方窗口：[B+1, B+2, ..., B+n]  
```
- **A**：最后一个被确认的包。  
- **B**：最后一个按序接收的包。  

**GBN与SR示例**  
- **GBN错误处理**：  
  - 包4丢失 → 接收方丢弃包5-6 → 发送方超时后重传包4-6。  
- **SR错误处理**：  
  - 包4丢失 → 接收方缓存包5-6 → 发送方仅重传包4。  

---

#### **5. 性能优化**  
**流水线（Pipelining）**  
- **原理**：允许发送方在未收到ACK前发送多个包。  
- **效果**：利用率提升至 `n * DATA/RTT`（n为窗口大小）。  

**TCP与UDP对比**  
| **特性**       | **TCP**                            | **UDP**                      |
|----------------|-----------------------------------|------------------------------|
| **可靠性**     | 可靠（确认、重传）                | 不可靠                       |
| **连接方式**   | 面向连接（三次握手）              | 无连接                       |
| **头部开销**   | 20字节                            | 8字节                        |
| **适用场景**   | HTTP、FTP、SMTP                   | DNS、VoIP、视频流            |


#### **6. 为什么某些应用更适合UDP？**  
**优势**：  
- **低延迟**：无需握手/重传（如实时游戏、VoIP）。  
- **轻量级**：头部仅8字节（TCP为20字节）。  
- **无拥塞控制**：适合容忍丢包但需恒定速率的应用（如直播）。  

**UDP检验和计算**：  
1. **覆盖范围**：伪头部（IP部分字段）+ UDP头 + 数据。  
2. **方法**：16位反码求和，结果取反存入校验和字段。  
   - 若校验和为0，表示未启用（但实际应避免）。  

---
