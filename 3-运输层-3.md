### **运输层-3**  
---

#### **1. TCP流量控制（Flow Control）**  
**目的**：防止发送方速率过快导致接收方缓冲区溢出。  
**机制**：  
- **通告窗口（Advertised Window, RWND）**：  
  - 接收方通过ACK报文中的`窗口字段`告知剩余缓冲区大小。  
  - 计算公式：`RWND = 接收缓冲区总大小 - (LastByteReceived - LastByteRead)`。  
- **发送方限制**：确保`已发送未确认字节数 ≤ min(RWND, CWND)`。  

**滑动窗口示例**：  
```
发送方窗口：  
[已确认 | 已发送未确认 | 可发送 | 不可发送]  
          ↑ CWND边界        ↑ RWND边界  
```

---

#### **2. TCP拥塞控制（Congestion Control）**  
**目标**：动态调整发送速率以避免网络拥塞，兼顾效率和公平性。  

##### **2.1 核心机制**  
| **机制**          | **触发条件**               | **行为**                              |  
|-------------------|---------------------------|---------------------------------------|  
| **慢启动（Slow Start）** | 连接建立或超时后          | CWND指数增长（每RTT翻倍）。            |  
| **拥塞避免（AIMD）**   | CWND ≥ ssthresh           | CWND线性增长（每RTT +1 MSS）。         |  
| **快速重传**         | 收到3个重复ACK            | 立即重传丢失报文，进入快速恢复。       |  
| **快速恢复**         | 快速重传后                | CWND = ssthresh + 3，逐步恢复传输。    |  

##### **2.2 状态转换图**  
```
Slow Start → (CWND ≥ ssthresh) → Congestion Avoidance  
   ↑________超时/3DupACK_________↓  
Fast Recovery → (新ACK到达) → Congestion Avoidance  
```

##### **2.3 参数调整**  
- **超时重传（RTO）**：基于动态RTT估计（指数加权平均）。  
- **ssthresh初始值**：通常设为较大值（如65535字节），首次丢包后更新为`CWND/2`。  

---

#### **3. 关键算法对比**  
| **算法**       | **增长方式**       | **减少方式**          | **公平性** | **适用场景**       |  
|----------------|--------------------|-----------------------|------------|--------------------|  
| **慢启动**     | 指数增长（×2/RTT） | 超时：CWND=1          | 低         | 初始阶段           |  
| **AIMD**       | 线性增长（+1/RTT） | 丢包：CWND= CWND/2    | 高         | 稳定阶段           |  
| **快速恢复**   | 线性增长           | 3DupACK：CWND=ssthresh+3 | 中         | 丢包恢复阶段       |  

---

#### **4. 拥塞控制示例**  
**场景**：CWND=8 MSS，ssthresh=8 MSS，发生丢包。  
1. **3个DupACK触发快速重传**：  
   - ssthresh = 4 MSS，CWND = 4 + 3 = 7 MSS。  
2. **新ACK到达后退出快速恢复**：  
   - CWND = ssthresh = 4 MSS，进入拥塞避免。  

**吞吐量锯齿图**：  
```
CWND
  ↑   /\
  |  /  \____
  | /        \___  
  +----------------→ Time
  Slow Start → AIMD → 丢包恢复
```

---

#### **5. 路由器辅助拥塞控制**  
**显式拥塞通知（ECN）**：  
- **机制**：路由器在IP头标记ECN位，接收方通过ACK反馈拥塞信号。  
- **优势**：避免丢包作为唯一拥塞信号，减少重传延迟。  

**与TCP的对比**：  
| **特性**       | **传统TCP**          | **ECN**               |  
|----------------|----------------------|-----------------------|  
| **拥塞信号**   | 丢包                 | 路由器显式标记        |  
| **响应速度**   | 慢（依赖超时）       | 快（即时反馈）        |  
| **适用环境**   | 高带宽延迟积（BDP）  | 低延迟敏感场景        |  

---

#### **6. 典型问题与解决策略**  
**Q: 为什么慢启动阶段采用指数增长？**  
- **答**：快速探测可用带宽，避免初始阶段过低利用率。  

**Q: AIMD如何保证公平性？**  
- **答**：多流竞争时，通过“乘性减”使各流收敛到公平份额（数学证明见AIMD模型）。  

**Q: 快速恢复为何添加3个MSS？**  
- **答**：补偿已发出的3个DupACK对应的数据包，保持管道填充。  
